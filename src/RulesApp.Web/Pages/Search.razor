@page "/search"
@using RulesApp.Shared
@inject HttpClient Http

<PageTitle>Recherche - RulesApp</PageTitle>

<h1>Recherche de r√®glements</h1>

<div class="search-container">
    <div class="search-box mb-3">
        <input type="text" 
               @bind="query" 
               @bind:event="oninput"
               @onkeypress="HandleKeyPress"
               placeholder="Rechercher dans les r√®glements..." 
               class="form-control form-control-lg" />
    </div>

    <div class="filters mb-3">
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="scopeCanada" @bind="includeCanada">
            <label class="form-check-label" for="scopeCanada">Canada</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="scopeQuebec" @bind="includeQuebec">
            <label class="form-check-label" for="scopeQuebec">Qu√©bec</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="scopeRegional" @bind="includeRegional">
            <label class="form-check-label" for="scopeRegional">R√©gional</label>
        </div>
    </div>

    @if (includeRegional)
    {
        <div class="association-input mb-3">
            <input type="text" 
                   @bind="associationId" 
                   placeholder="Code d'association (requis pour r√©gional)" 
                   class="form-control" />
        </div>
    }

    <button @onclick="SearchAsync" class="btn btn-primary" disabled="@isSearching">
        @if (isSearching)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <span>Recherche en cours...</span>
        }
        else
        {
            <span>Rechercher</span>
        }
    </button>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger mt-3" role="alert">
        @errorMessage
    </div>
}

@if (results != null)
{
    <div class="results mt-4">
        <h3>@results.TotalResults r√©sultat(s) pour "@results.Query"</h3>
        
        @if ((results.RuleGroups == null || results.RuleGroups.Count == 0) && 
             (results.UngroupedResults == null || results.UngroupedResults.Count == 0))
        {
            <div class="alert alert-info">
                Aucun r√©sultat trouv√©. Essayez d'autres mots-cl√©s.
            </div>
        }
        else
        {
            @* Display rule groups first *@
            @if (results.RuleGroups != null)
            {
                @foreach (var group in results.RuleGroups)
                {
                    <div class="card mb-3 border-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">
                                    @if (!string.IsNullOrEmpty(group.PrimaryChunk.RuleNumberText))
                                    {
                                        <span class="badge bg-primary me-2">@group.PrimaryChunk.RuleNumberText</span>
                                    }
                                    @(group.PrimaryChunk.Title ?? "R√®glement")
                                    <span class="badge bg-success ms-2">R√®gle principale</span>
                                </h5>
                            </div>
                            <p class="card-text">@group.PrimaryChunk.TextPreview...</p>
                            <div class="text-muted small">
                                <span class="me-3">üìÑ Pages @group.PrimaryChunk.PageStart-@group.PrimaryChunk.PageEnd</span>
                                <span class="me-3">üìö @group.PrimaryChunk.Scope (@group.PrimaryChunk.DocType)</span>
                                @if (!string.IsNullOrEmpty(group.PrimaryChunk.AssociationId))
                                {
                                    <span class="me-3">üè¢ @group.PrimaryChunk.AssociationId</span>
                                }
                                <span>‚≠ê Score: @group.PrimaryChunk.Score.ToString("F2")</span>
                            </div>
                            
                            @* Show alternate chunks if any *@
                            @if (group.AlternateChunks != null && group.AlternateChunks.Count > 0)
                            {
                                <div class="mt-3">
                                    <h6 class="text-muted">Versions alternatives (@group.AlternateChunks.Count):</h6>
                                    @foreach (var alt in group.AlternateChunks)
                                    {
                                        <div class="card border-secondary mt-2">
                                            <div class="card-body py-2">
                                                <div class="text-muted small">
                                                    <span class="me-3">üìö @alt.Scope (@alt.DocType)</span>
                                                    <span class="me-3">üìÑ Pages @alt.PageStart-@alt.PageEnd</span>
                                                    @if (!string.IsNullOrEmpty(alt.AssociationId))
                                                    {
                                                        <span class="me-3">üè¢ @alt.AssociationId</span>
                                                    }
                                                    <span>‚≠ê @alt.Score.ToString("F2")</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            
            @* Display ungrouped results *@
            @if (results.UngroupedResults != null)
            {
                @foreach (var hit in results.UngroupedResults)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">
                                @if (!string.IsNullOrEmpty(hit.RuleNumberText))
                                {
                                    <span class="badge bg-secondary me-2">@hit.RuleNumberText</span>
                                }
                                @(hit.Title ?? "R√®glement")
                            </h5>
                            <p class="card-text">@hit.TextPreview...</p>
                            <div class="text-muted small">
                                <span class="me-3">üìÑ Pages @hit.PageStart-@hit.PageEnd</span>
                                <span class="me-3">üìö @hit.Scope (@hit.DocType)</span>
                                @if (!string.IsNullOrEmpty(hit.AssociationId))
                                {
                                    <span class="me-3">üè¢ @hit.AssociationId</span>
                                }
                                <span>‚≠ê Score: @hit.Score.ToString("F2")</span>
                            </div>
                        </div>
                    </div>
                }
            }
        }
    </div>
}

@code {
    private string query = "";
    private bool includeCanada = true;
    private bool includeQuebec = true;
    private bool includeRegional = false;
    private string? associationId;
    private SearchResponseWithPrecedence? results;
    private string? errorMessage;
    private bool isSearching = false;

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(query))
        {
            errorMessage = "Veuillez entrer une requ√™te de recherche.";
            return;
        }

        if (includeRegional && string.IsNullOrWhiteSpace(associationId))
        {
            errorMessage = "Le code d'association est requis pour la recherche r√©gionale.";
            return;
        }

        errorMessage = null;
        isSearching = true;
        results = null;

        try
        {
            var scopes = new List<string>();
            if (includeCanada) scopes.Add("Canada");
            if (includeQuebec) scopes.Add("Quebec");
            if (includeRegional) scopes.Add("Regional");

            if (scopes.Count == 0)
            {
                errorMessage = "Veuillez s√©lectionner au moins un niveau de r√®glements.";
                return;
            }

            var request = new SearchRequest(query, null, associationId, scopes, 10);
            var response = await Http.PostAsJsonAsync("api/search", request);

            if (response.IsSuccessStatusCode)
            {
                results = await response.Content.ReadFromJsonAsync<SearchResponseWithPrecedence>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Erreur lors de la recherche: {response.StatusCode} - {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur: {ex.Message}";
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isSearching)
        {
            await SearchAsync();
        }
    }
}
