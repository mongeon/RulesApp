@page "/search"
@using RulesApp.Shared
@inject HttpClient Http
@inject LanguageState LanguageState
@implements IDisposable

<PageTitle>@L("Recherche - RulesApp", "Search - RulesApp")</PageTitle>

<h1>@L("Recherche de r√®glements", "Rule search")</h1>

<div class="search-container">
    <div class="search-box mb-3">
        <input type="text" 
               @bind="query" 
               @bind:event="oninput"
               @onkeypress="HandleKeyPress"
               placeholder="@L("Rechercher dans les r√®glements...", "Search the rulebooks...")" 
               class="form-control form-control-lg" />
    </div>

    <div class="filters mb-3">
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="scopeCanada" @bind="includeCanada">
            <label class="form-check-label" for="scopeCanada">Canada</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="scopeQuebec" @bind="includeQuebec">
            <label class="form-check-label" for="scopeQuebec">@L("Qu√©bec", "Quebec")</label>
        </div>
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="scopeRegional" @bind="includeRegional">
            <label class="form-check-label" for="scopeRegional">@L("R√©gional", "Regional")</label>
        </div>
    </div>

    @if (includeRegional)
    {
        <div class="association-input mb-3">
            <label for="associationSelect" class="form-label">@L("Association (r√©gional)", "Association (regional)")</label>
            <select id="associationSelect" class="form-select" @bind="selectedAssociation" disabled="@isLoadingAssociations">
                <option value="">@L("-- S√©lectionner une association --", "-- Select an association --")</option>
                @foreach (var option in associationOptions)
                {
                    <option value="@option">@option</option>
                }
            </select>
            @if (isLoadingAssociations)
            {
                <small class="form-text text-muted">@L("Chargement des associations...", "Loading associations...")</small>
            }
            else if (associationsLoadFailed)
            {
                <small class="form-text text-danger">@L("Impossible de charger les associations. R√©essayez plus tard.", "Unable to load associations. Please try again later.")</small>
            }
            else
            {
                <small class="form-text text-muted">@L("Requis pour les r√®gles r√©gionales", "Required for regional rules")</small>
            }
        </div>
    }

    <button @onclick="SearchAsync" class="btn btn-primary" disabled="@isSearching">
        @if (isSearching)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            <span>@L("Recherche en cours...", "Searching...")</span>
        }
        else
        {
            <span>@L("Rechercher", "Search")</span>
        }
    </button>
</div>

@if (errorMessage != null)
{
    <div class="alert alert-danger mt-3" role="alert">
        @errorMessage
    </div>
}

@if (results != null)
{
    <div class="results mt-4">
        <h3>@results.TotalResults @L("r√©sultat(s) pour", "result(s) for") "@results.Query"</h3>
        
        @if ((results.RuleGroups == null || results.RuleGroups.Count == 0) && 
             (results.UngroupedResults == null || results.UngroupedResults.Count == 0))
        {
            <div class="alert alert-info">
                @L("Aucun r√©sultat trouv√©. Essayez d'autres mots-cl√©s.", "No results found. Try different keywords.")
            </div>
        }
        else
        {
            @* Display rule groups first *@
            @if (results.RuleGroups != null)
            {
                @foreach (var group in results.RuleGroups)
                {
                    <div class="card mb-3 border-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">
                                    @if (!string.IsNullOrEmpty(group.PrimaryChunk.RuleNumberText))
                                    {
                                        <span class="badge bg-primary me-2">@group.PrimaryChunk.RuleNumberText</span>
                                    }
                                    @(group.PrimaryChunk.Title ?? "R√®glement")
                                    <span class="badge bg-success ms-2">@L("R√®gle principale", "Primary rule")</span>
                                </h5>
                            </div>
                            <p class="card-text">@group.PrimaryChunk.TextPreview...</p>
                            <div class="text-muted small">
                                <span class="me-3">üìÑ @L("Pages", "Pages") @group.PrimaryChunk.PageStart-@group.PrimaryChunk.PageEnd</span>
                                <span class="me-3">üìö @group.PrimaryChunk.Scope (@group.PrimaryChunk.DocType)</span>
                                @if (!string.IsNullOrEmpty(group.PrimaryChunk.AssociationId))
                                {
                                    <span class="me-3">üè¢ @group.PrimaryChunk.AssociationId</span>
                                }
                                <span>‚≠ê Score: @group.PrimaryChunk.Score.ToString("F2")</span>
                            </div>
                            
                            @* Show alternate chunks if any *@
                            @if (group.AlternateChunks != null && group.AlternateChunks.Count > 0)
                            {
                                <div class="mt-3">
                                    <h6 class="text-muted">@L("Versions alternatives", "Alternate versions") (@group.AlternateChunks.Count):</h6>
                                    @foreach (var alt in group.AlternateChunks)
                                    {
                                        <div class="card border-secondary mt-2">
                                            <div class="card-body py-2">
                                                <div class="text-muted small">
                                                    <span class="me-3">üìö @alt.Scope (@alt.DocType)</span>
                                                    <span class="me-3">üìÑ @L("Pages", "Pages") @alt.PageStart-@alt.PageEnd</span>
                                                    @if (!string.IsNullOrEmpty(alt.AssociationId))
                                                    {
                                                        <span class="me-3">üè¢ @alt.AssociationId</span>
                                                    }
                                                    <span>‚≠ê @alt.Score.ToString("F2")</span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            
            @* Display ungrouped results *@
            @if (results.UngroupedResults != null)
            {
                @foreach (var hit in results.UngroupedResults)
                {
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">
                                @if (!string.IsNullOrEmpty(hit.RuleNumberText))
                                {
                                    <span class="badge bg-secondary me-2">@hit.RuleNumberText</span>
                                }
                                @(hit.Title ?? L("R√®glement", "Rule"))
                            </h5>
                            <p class="card-text">@hit.TextPreview...</p>
                            <div class="text-muted small">
                                <span class="me-3">üìÑ @L("Pages", "Pages") @hit.PageStart-@hit.PageEnd</span>
                                <span class="me-3">üìö @hit.Scope (@hit.DocType)</span>
                                @if (!string.IsNullOrEmpty(hit.AssociationId))
                                {
                                    <span class="me-3">üè¢ @hit.AssociationId</span>
                                }
                                <span>‚≠ê Score: @hit.Score.ToString("F2")</span>
                            </div>
                        </div>
                    </div>
                }
            }
        }
    </div>
}

@code {
    private string query = "";
    private bool includeCanada = true;
    private bool includeQuebec = true;
    private bool includeRegional = false;
    private List<string> associationOptions = new();
    private bool isLoadingAssociations = true;
    private bool associationsLoadFailed = false;
    private string selectedAssociation = "";
    private SearchResponseWithPrecedence? results;
    private string? errorMessage;
    private bool isSearching = false;

    protected override async Task OnInitializedAsync()
    {
        LanguageState.OnChange += HandleLanguageChanged;
        await LoadAssociationsAsync();
    }

    private async Task LoadAssociationsAsync()
    {
        try
        {
            isLoadingAssociations = true;
            associationsLoadFailed = false;
            var response = await Http.GetFromJsonAsync<AssociationListResponse>("api/associations");
            associationOptions = response?.Associations ?? new List<string>();
        }
        catch
        {
            associationsLoadFailed = true;
            associationOptions = new List<string>();
        }
        finally
        {
            isLoadingAssociations = false;
        }
    }

    private void HandleLanguageChanged()
    {
        StateHasChanged();
    }

    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(query))
        {
            errorMessage = L("Veuillez entrer une requ√™te de recherche.", "Please enter a search query.");
            return;
        }

        if (includeRegional && string.IsNullOrWhiteSpace(selectedAssociation))
        {
            errorMessage = L("Le code d'association est requis pour la recherche r√©gionale.", "Association code is required for regional search.");
            return;
        }

        errorMessage = null;
        isSearching = true;
        results = null;

        try
        {
            var scopes = new List<string>();
            if (includeCanada) scopes.Add("Canada");
            if (includeQuebec) scopes.Add("Quebec");
            if (includeRegional) scopes.Add("Regional");

            if (scopes.Count == 0)
            {
                errorMessage = L("Veuillez s√©lectionner au moins un niveau de r√®glements.", "Select at least one scope.");
                return;
            }

            var associationId = string.IsNullOrWhiteSpace(selectedAssociation) ? null : selectedAssociation;
            var request = new SearchRequest(query, null, associationId, scopes, 10);
            var response = await Http.PostAsJsonAsync("api/search", request);

            if (response.IsSuccessStatusCode)
            {
                results = await response.Content.ReadFromJsonAsync<SearchResponseWithPrecedence>();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = L($"Erreur lors de la recherche: {response.StatusCode} - {error}", $"Search error: {response.StatusCode} - {error}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = L($"Erreur: {ex.Message}", $"Error: {ex.Message}");
        }
        finally
        {
            isSearching = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isSearching)
        {
            await SearchAsync();
        }
    }

    private bool IsEnglish => LanguageState.Current == "EN";
    private string L(string fr, string en) => IsEnglish ? en : fr;

    public void Dispose()
    {
        LanguageState.OnChange -= HandleLanguageChanged;
    }
}
